# Xcode项目解析与BSP目标转换

## 概览

本文档描述了sourcekit-bsp如何扫描和解析工作目录，获取BSP目标和构建设置索引（编译参数）以供LSP使用。

## 目录结构支持的情况

工作目录下可能存在的Xcode项目结构：

1. **多个工作区** (.xcworkspace)
2. **单个工作区** (.xcworkspace)
3. **多个项目** (.xcodeproj)
4. **单个项目** (.xcodeproj)

> **注意**: 项目可能依赖于根目录之外的其他项目

## 过滤逻辑

### 目标去重
确保相同的目标只出现一次，避免重复处理

### 用户偏好过滤
基于用户配置的工作区和项目偏好进行过滤

## 配置文件

### 配置路径
`.sourcekit-bsp/project.json`

### 配置格式
```json
{
  "workspace": "path/to/workspace.xcworkspace",
  "project": "path/to/project.xcodeproj",
  "scheme": "MyScheme",
  "target": "MyTarget",
  "configuration": "Debug"
}
```

### 配置项说明
- `workspace`: 指定工作区路径（绝对路径或相对于根目录的路径）
- `project`: 指定项目路径（绝对路径或相对于根目录的路径）
- `scheme`: 指定构建方案
- `target`: 指定目标名称
- `configuration`: 指定构建配置（如Debug, Release）

## 实现详情

### 1. 项目发现流程

#### 显式配置处理
如果配置文件中指定了具体的工作区或项目：
- 验证路径是否存在
- 加载指定的工作区/项目
- 跳过自动发现流程

#### 自动发现流程
当没有显式配置时，按以下顺序进行：

1. **扫描工作区文件**
   - 在根目录查找 `.xcworkspace` 文件
   - 如果找到一个：使用该工作区
   - 如果找到多个：抛出多工作区错误

2. **扫描项目文件**
   - 在根目录查找 `.xcodeproj` 文件
   - 如果找到一个：检查是否有隐式工作区
   - 如果找到多个：抛出多项目错误

3. **隐式工作区处理**
   - 检查项目内的 `project.xcworkspace`
   - 如果存在：使用隐式工作区
   - 如果不存在：直接使用项目文件

### 2. 过滤策略

#### 工作区过滤
当指定工作区时：
- 解析工作区内的所有项目引用
- 只处理工作区内包含的项目
- 忽略工作区外的独立项目

#### 项目过滤
当指定项目时：
- 只处理指定的项目文件
- 检查项目的依赖关系
- 可能需要加载依赖的其他项目

#### 配置过滤
当指定构建配置时：
- 只提取指定配置的构建设置
- 减少不必要的配置解析
- 提高解析性能

### 3. BSP目标转换

#### 目标标识符格式
```
xcode://{projectPath}{targetName}
```

#### 目标分类
- **应用程序目标**: `.application`
- **测试目标**: `.test`
- **集成测试目标**: `.integrationTest`
- **库目标**: `.library`

#### 语言检测
- 主要支持Swift和Objective-C
- 基于源文件扩展名进行检测
- 默认为Swift语言

### 4. 构建设置提取

#### 索引构建设置
为每个文件提取特定的编译参数：
- Swift AST命令参数
- 模块名称
- 语言方言
- 输出文件路径

#### 缓存策略
- 构建设置在会话期间保持在内存中
- 方案信息被缓存以避免重复解析
- 目标分类结果被缓存

## 性能优化建议

### 当前优化
1. **方案缓存**: 方案加载一次后重复使用
2. **构建设置重用**: 每个项目的构建设置只计算一次
3. **批量处理**: 支持多目标批量处理
4. **智能回退**: 缺失设置时的智能回退机制

### 潜在优化
1. **持久化缓存**: 实现跨会话的缓存机制
2. **增量更新**: 支持文件变更时的增量更新
3. **并行处理**: 改进多目标并行处理能力
4. **内存管理**: 实现更高效的内存使用策略

## 错误处理

### 常见错误类型
- `projectNotFound`: 未找到项目或工作区
- `multipleWorkspaces`: 发现多个工作区
- `multipleProjectsWithoutWorkspace`: 无工作区时发现多个项目
- `invalidConfig`: 配置文件无效
- `schemeNotFound`: 指定的方案不存在
- `targetNotFound`: 指定的目标不存在

### 错误处理策略
- 提供详细的错误信息
- 建议用户配置解决方案
- 支持回退到默认行为

## 最佳实践

1. **使用配置文件**: 对于复杂项目，建议使用 `.bsp/xcode.json` 明确指定项目结构
2. **选择合适的配置**: 根据开发需求选择合适的构建配置
3. **定期清理**: 定期清理派生数据以确保构建设置的准确性
4. **监控性能**: 对于大型项目，监控解析性能并考虑使用过滤器

## 相关文件

- `XcodeProjectLocator.swift`: 项目发现和定位逻辑
- `XcodeToBSPAdapter.swift`: BSP目标转换核心逻辑
- `XcodeSettingsLoader.swift`: 构建设置提取
- `XcodeProjectManager.swift`: 项目管理和多项目支持
- `BuildServerContext.swift`: BSP服务上下文和入口点